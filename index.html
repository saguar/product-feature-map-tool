<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product-Feature Relationship Map</title>
    <script>
      tailwind.config = { darkMode: 'class' };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- Added html2canvas library for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body, html {
            overflow: hidden;
            height: 100%;
            font-family: 'Inter', sans-serif;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 80px);
        }
        .list-item.selected {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
        .list-item.linked {
            background-color: #e0e7ff; /* indigo-100 */
            border-style: dashed;
        }
        .list-item.hovered {
            background-color: #fef9c3; /* yellow-100 */
        }
        #svg-connector-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .list-item-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .list-item:hover .list-item-actions {
            opacity: 1;
        }
        .mode-button.active {
            background-color: #0284c7; /* sky-600 */
            color: white;
            font-weight: 600;
        }
        .toggle-children {
            cursor: pointer;
            width: 1rem;
            height: 1rem;
            display: inline-block;
            margin-right: 0.25rem;
            user-select: none;
        }
        .context-menu {
            position: absolute;
            z-index: 20;
            display: none;
        }
        .list-item.dragging {
            opacity: 0.5;
        }
        .drop-indicator {
            height: 2px;
            background-color: #3b82f6;
            margin: 2px 0;
        }
        .add-mode-tab.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        :root {
            --connector-color: #94a3b8;
        }
        html.dark {
            --connector-color: #cbd5e1;
        }
        html.theme-blue {
            --connector-color: #0ea5e9;
        }
        html.theme-green {
            --connector-color: #10b981;
        }
        html.theme-blue body {
            background-color: #e0f2fe;
        }
        html.theme-green body {
            background-color: #ecfdf5;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div class="w-full h-full flex flex-col">
        <!-- Top Control Bar -->
        <div class="w-full bg-white dark:bg-slate-800 shadow-md p-4 flex items-center gap-6 border-b border-slate-200 dark:border-slate-700 z-10">
            <div id="mode-switcher" class="bg-slate-200 rounded-lg p-1">
                <button id="editor-mode-btn" onclick="setMode('editor')" class="mode-button px-3 py-1 rounded-md text-sm text-slate-700 transition-colors">Editor</button>
                <button id="viewer-mode-btn" onclick="setMode('viewer')" class="mode-button px-3 py-1 rounded-md text-sm text-slate-700 transition-colors">Viewer</button>
            </div>
            
            <div class="h-8 border-l border-slate-300 dark:border-slate-600"></div>

            <div id="editor-controls" class="flex items-center gap-6">
                <button onclick="openAddModal('product')" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700 transition-colors shadow">Add Product</button>
                <button id="add-child-btn" onclick="handleAddChildProduct()" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors shadow disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>Add Child</button>
                <button onclick="openAddModal('feature')" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700 transition-colors shadow">Add Feature</button>
            </div>
            
            <div class="h-8 border-l border-slate-300 dark:border-slate-600"></div>

            <div>
                <button id="save-btn" onclick="saveMapToJSON()" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-green-700 transition-colors shadow">Save (JSON)</button>
                <label for="json-file-input" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-gray-700 transition-colors shadow cursor-pointer">Load (JSON)</label>
                <input type="file" id="json-file-input" accept=".json" onchange="loadMapFromJSON(event)">
                <button onclick="exportToPNG()" class="bg-purple-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-purple-700 transition-colors shadow">Export (PNG)</button>
            </div>
            <div class="ml-auto">
                <select id="theme-select" class="p-2 rounded-md bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                </select>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="export-area" class="flex-grow p-8 relative bg-slate-50 dark:bg-slate-900">
            <div class="main-container">
                <!-- Products Column -->
                <div id="products-column" class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4 text-center">Products</h2>
                    <div id="products-list" class="space-y-2 list-none"></div>
                </div>
                <!-- Features Column -->
                <div id="features-column" class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-800 dark:text-slate-100 mb-4 text-center">Features</h2>
                    <div id="features-list" class="space-y-2 list-none"></div>
                </div>
            </div>
            <svg id="svg-connector-canvas"></svg>
        </main>
    </div>
    
    <!-- Context Menus -->
    <div id="product-context-menu" class="context-menu bg-white dark:bg-slate-800 rounded-md shadow-lg border border-slate-200 dark:border-slate-700 w-48">
        <ul class="py-1">
            <li onclick="handleAddChildFromContext()" class="px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer text-slate-700 dark:text-slate-200">Add Child</li>
        </ul>
    </div>

    <!-- Modals -->
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <input type="text" id="modal-input" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 dark:text-slate-100">
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeInputModal()" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cancel</button>
                <button onclick="handleModalSave()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-600 mb-4"></p>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cancel</button>
                <button onclick="handleModalConfirm()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="add-modal-title" class="text-lg font-bold mb-4"></h3>
            <div class="border-b border-gray-200 dark:border-gray-600 mb-4">
                <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                    <button onclick="switchAddMode('single')" id="single-tab" class="add-mode-tab whitespace-nowrap py-2 px-4 border-b-2 font-medium text-sm">Single</button>
                    <button onclick="switchAddMode('bulk')" id="bulk-tab" class="add-mode-tab whitespace-nowrap py-2 px-4 border-b-2 font-medium text-sm">Bulk</button>
                </nav>
            </div>
            <div id="single-add-panel">
                <label for="add-modal-input-single" class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" id="add-modal-input-single" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 dark:text-slate-100">
            </div>
            <div id="bulk-add-panel" class="hidden">
                <label for="add-modal-input-bulk" class="block text-sm font-medium text-gray-700">Names (one per line)</label>
                <textarea id="add-modal-input-bulk" rows="5" class="mt-1 w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 dark:text-slate-100"></textarea>
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeAddModal()" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cancel</button>
                <button onclick="handleBulkAddSave()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <script>
    // --- DATA MANAGEMENT ---
    let products = [];
    let features = [];
    let links = [];
    let allLinks = [];
    let selectedItem = { id: null, type: null };
    let hoveredItem = { id: null, type: null };
    let currentMode = 'editor';
    let rightClickedProductId = null;
    let draggedProductId = null;
    let currentAddType = 'product';
    let currentAddMode = 'single';

    function generateUUID() {
        if (typeof crypto.randomUUID === 'function') {
            return crypto.randomUUID();
        }
        if (crypto.getRandomValues) {
            const bytes = crypto.getRandomValues(new Uint8Array(16));
            bytes[6] = (bytes[6] & 0x0f) | 0x40;
            bytes[8] = (bytes[8] & 0x3f) | 0x80;
            return [...bytes].map((b, i) => {
                const s = b.toString(16).padStart(2, '0');
                return (i === 4 || i === 6 || i === 8 || i === 10 ? '-' : '') + s;
            }).join('');
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function isDescendant(ancestorId, descendantId) {
        let current = products.find(p => p.id === descendantId);
        while (current && current.parentId) {
            if (current.parentId === ancestorId) return true;
            current = products.find(p => p.id === current.parentId);
        }
        return false;
    }

    function getAncestors(productId) {
        const ancestors = [];
        let current = products.find(p => p.id === productId);
        while (current && current.parentId) {
            current = products.find(p => p.id === current.parentId);
            if (current) ancestors.push(current.id);
        }
        return ancestors;
    }

    function getAllLinks() {
        const result = links.map(l => ({ ...l, inherited: false }));
        links.forEach(link => {
            const ancestors = getAncestors(link.productId);
            ancestors.forEach(ancestorId => {
                if (!result.some(l => l.productId === ancestorId && l.featureId === link.featureId)) {
                    result.push({ productId: ancestorId, featureId: link.featureId, inherited: true });
                }
            });
        });
        return result;
    }

    // --- DOM ELEMENTS ---
    const productsListEl = document.getElementById('products-list');
    const featuresListEl = document.getElementById('features-list');
    const svgCanvas = document.getElementById('svg-connector-canvas');
    const addChildBtn = document.getElementById('add-child-btn');
    const productContextMenu = document.getElementById('product-context-menu');
    const inputModal = document.getElementById('input-modal'), modalTitle = document.getElementById('modal-title'), modalInput = document.getElementById('modal-input');
    const confirmModal = document.getElementById('confirm-modal'), confirmModalText = document.getElementById('confirm-modal-text');
    const addModal = document.getElementById('add-modal'), addModalTitle = document.getElementById('add-modal-title');
    const productsColumnEl = document.getElementById('products-column');
    const featuresColumnEl = document.getElementById('features-column');

    // --- MODAL STATE ---
    let onSaveCallback = null;
    let onConfirmCallback = null;

    // --- RENDER FUNCTIONS ---
    function renderAll() {
        allLinks = getAllLinks();
        renderProducts();
        renderFeatures();
        setTimeout(drawConnectors, 0);
    }

    function renderProducts() {
        productsListEl.innerHTML = '';
        const productTree = buildProductTree();
        productTree.forEach(product => renderProductItem(product, 0));
    }

    function buildProductTree(parentId = null) {
        return products
            .filter(p => p.parentId === parentId)
            .map(p => ({ ...p, children: buildProductTree(p.id) }));
    }

    function renderProductItem(product, level) {
        let itemClass = 'list-item p-3 border rounded-md flex justify-between items-center transition-colors border-slate-300 dark:border-slate-600 dark:bg-slate-700';
        if (currentMode === 'editor') {
            itemClass += ' cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600';
            if (selectedItem.type === 'product' && product.id === selectedItem.id) itemClass += ' selected';
        }
        if (selectedItem.type === 'feature' && allLinks.some(l => l.productId === product.id && l.featureId === selectedItem.id)) itemClass += ' linked';
        if (currentMode === 'viewer' && hoveredItem.type === 'feature' && allLinks.some(l => l.productId === product.id && l.featureId === hoveredItem.id)) itemClass += ' linked';
        if (currentMode === 'viewer' && hoveredItem.type === 'product' && product.id === hoveredItem.id) itemClass += ' hovered';

        const item = document.createElement('div');
        item.className = itemClass;
        item.dataset.id = product.id;
        item.style.marginLeft = `${level * 2}rem`;
        
        if (currentMode === 'editor') {
            item.setAttribute('draggable', true);
            item.ondragstart = (e) => handleDragStart(e, product.id);
            item.ondragover = (e) => handleDragOver(e, product.id);
            item.ondragleave = (e) => handleDragLeave(e);
            item.ondrop = (e) => handleDrop(e, product.id);
            item.ondragend = (e) => handleDragEnd(e);
        }

        item.onclick = () => handleSelectItem('product', product.id);
        item.onmouseover = (e) => { e.stopPropagation(); handleHoverItem('product', product.id); };
        item.onmouseout = (e) => { e.stopPropagation(); handleHoverItem(null, null); };
        item.oncontextmenu = (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (currentMode !== 'editor') return;
            rightClickedProductId = product.id;
            productContextMenu.style.top = `${e.clientY}px`;
            productContextMenu.style.left = `${e.clientX}px`;
            productContextMenu.style.display = 'block';
        };

        const hasChildren = product.children && product.children.length > 0;
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'flex items-center';

        const toggleSpan = document.createElement('span');
        toggleSpan.className = 'toggle-children';
        if (hasChildren) {
            toggleSpan.textContent = product.isCollapsed ? '\u25BA' : '\u25BC';
            toggleSpan.onclick = (e) => { e.stopPropagation(); toggleCollapse(product.id); };
        }
        contentWrapper.appendChild(toggleSpan);

        const nameSpan = document.createElement('span');
        nameSpan.textContent = product.name;
        contentWrapper.appendChild(nameSpan);
        item.appendChild(contentWrapper);

        if (currentMode === 'editor') {
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'list-item-actions space-x-2';

            const editBtn = document.createElement('button');
            editBtn.onclick = (e) => { e.stopPropagation(); handleEditProduct(product.id); };
            editBtn.className = 'text-slate-500 hover:text-blue-600';
            editBtn.title = 'Edit';
            editBtn.innerHTML = '&#9998;';
            actionsDiv.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.onclick = (e) => { e.stopPropagation(); handleDeleteProduct(product.id); };
            deleteBtn.className = 'text-slate-500 hover:text-red-600';
            deleteBtn.title = 'Delete';
            deleteBtn.innerHTML = '&#10006;';
            actionsDiv.appendChild(deleteBtn);

            item.appendChild(actionsDiv);
        }
        productsListEl.appendChild(item);

        if (hasChildren && !product.isCollapsed) {
            product.children.forEach(child => renderProductItem(child, level + 1));
        }
    }

    function renderFeatures() {
        featuresListEl.innerHTML = '';
        features.forEach(feature => {
            let itemClass = 'list-item p-3 border rounded-md flex justify-between items-center transition-colors border-slate-300 dark:border-slate-600 dark:bg-slate-700';
            let showLinkBtn = false;
            let isLinked = false;
            let linkBtnColor = '';
            let linkBtnText = '';
            if (currentMode === 'editor') {
                itemClass += ' cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600';
                if (selectedItem.type === 'feature' && feature.id === selectedItem.id) itemClass += ' selected';
                if (selectedItem.type === 'product') {
                    isLinked = links.some(l => l.productId === selectedItem.id && l.featureId === feature.id);
                    if (allLinks.some(l => l.productId === selectedItem.id && l.featureId === feature.id)) itemClass += ' linked';
                    showLinkBtn = true;
                    linkBtnText = isLinked ? 'Unlink' : 'Link';
                    linkBtnColor = isLinked ? 'bg-amber-500 hover:bg-amber-600' : 'bg-teal-500 hover:bg-teal-600';
                }
            }
            if (currentMode === 'viewer' && hoveredItem.type === 'product' && allLinks.some(l => l.featureId === feature.id && l.productId === hoveredItem.id)) itemClass += ' linked';
            if (currentMode === 'viewer' && hoveredItem.type === 'feature' && feature.id === hoveredItem.id) itemClass += ' hovered';

            const item = document.createElement('div');
            item.className = itemClass;
            item.dataset.id = feature.id;
            item.onclick = () => handleSelectItem('feature', feature.id);
            item.onmouseover = (e) => { e.stopPropagation(); handleHoverItem('feature', feature.id); };
            item.onmouseout = (e) => { e.stopPropagation(); handleHoverItem(null, null); };

            const nameSpan = document.createElement('span');
            nameSpan.textContent = feature.name;
            item.appendChild(nameSpan);

            const rightDiv = document.createElement('div');
            rightDiv.className = 'flex items-center gap-2';

            if (showLinkBtn) {
                const linkBtn = document.createElement('button');
                linkBtn.onclick = (e) => { e.stopPropagation(); handleToggleLink(feature.id); };
                linkBtn.className = `text-xs text-white px-2 py-1 rounded ${linkBtnColor}`;
                linkBtn.textContent = linkBtnText;
                rightDiv.appendChild(linkBtn);
            }

            if (currentMode === 'editor') {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'list-item-actions space-x-2';

                const editBtn = document.createElement('button');
                editBtn.onclick = (e) => { e.stopPropagation(); handleEditFeature(feature.id); };
                editBtn.className = 'text-slate-500 hover:text-blue-600';
                editBtn.title = 'Edit';
                editBtn.innerHTML = '&#9998;';
                actionsDiv.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.onclick = (e) => { e.stopPropagation(); handleDeleteFeature(feature.id); };
                deleteBtn.className = 'text-slate-500 hover:text-red-600';
                deleteBtn.title = 'Delete';
                deleteBtn.innerHTML = '&#10006;';
                actionsDiv.appendChild(deleteBtn);

                rightDiv.appendChild(actionsDiv);
            }

            item.appendChild(rightDiv);
            featuresListEl.appendChild(item);
        });
    }
    
    function drawConnectors() {
        svgCanvas.innerHTML = '';
        const itemToDraw = currentMode === 'editor' ? selectedItem : hoveredItem;
        if (!itemToDraw.id) return;

        if (itemToDraw.type === 'product') {
            const productEl = document.querySelector(`#products-list .list-item[data-id="${itemToDraw.id}"]`);
            if (!productEl) return;
            const linkedFeatureIds = allLinks.filter(l => l.productId === itemToDraw.id).map(l => l.featureId);
            linkedFeatureIds.forEach(featureId => {
                const featureEl = document.querySelector(`#features-list .list-item[data-id="${featureId}"]`);
                if (featureEl) drawBezierCurve(productEl, featureEl);
            });
        } else if (itemToDraw.type === 'feature') {
            const featureEl = document.querySelector(`#features-list .list-item[data-id="${itemToDraw.id}"]`);
            if (!featureEl) return;
            const linkedProductIds = allLinks.filter(l => l.featureId === itemToDraw.id).map(l => l.productId);
            linkedProductIds.forEach(productId => {
                const productEl = document.querySelector(`#products-list .list-item[data-id="${productId}"]`);
                if (productEl) drawBezierCurve(productEl, featureEl);
            });
        }
    }

    function drawBezierCurve(startEl, endEl) {
        const svgParentRect = svgCanvas.parentElement.getBoundingClientRect();
        const startRect = startEl.getBoundingClientRect();
        const endRect = endEl.getBoundingClientRect();
        const x1 = startRect.right - svgParentRect.left;
        const y1 = (startRect.top + startRect.height / 2) - svgParentRect.top;
        const x2 = endRect.left - svgParentRect.left;
        const y2 = (endRect.top + endRect.height / 2) - svgParentRect.top;
        const cx = (x1 + x2) / 2;
        const pathData = `M ${x1},${y1} C ${cx},${y1} ${cx},${y2} ${x2},${y2}`;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        const strokeColor = getComputedStyle(document.documentElement).getPropertyValue('--connector-color').trim() || '#94a3b8';
        path.setAttribute('stroke', strokeColor);
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        svgCanvas.appendChild(path);
    }

    // --- MODAL HANDLERS ---
    function openInputModal(title, value, callback) {
        modalTitle.textContent = title;
        modalInput.value = value;
        onSaveCallback = callback;
        inputModal.classList.remove('hidden');
        modalInput.focus();
    }
    function closeInputModal() { inputModal.classList.add('hidden'); onSaveCallback = null; }
    function handleModalSave() {
        if (onSaveCallback && modalInput.value.trim()) onSaveCallback(modalInput.value.trim());
        closeInputModal();
    }
    function openConfirmModal(text, callback) {
        confirmModalText.textContent = text;
        onConfirmCallback = callback;
        confirmModal.classList.remove('hidden');
    }
    function closeConfirmModal() { confirmModal.classList.add('hidden'); onConfirmCallback = null; }
    function handleModalConfirm() {
        if (onConfirmCallback) onConfirmCallback();
        closeConfirmModal();
    }
    modalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleModalSave();
        if (e.key === 'Escape') closeInputModal();
    });

    // --- ADD MODAL (SINGLE/BULK) ---
    function openAddModal(type) {
        currentAddType = type;
        addModalTitle.textContent = `Add new ${type}(s)`;
        switchAddMode('single');
        addModal.classList.remove('hidden');
        document.getElementById('add-modal-input-single').focus();
    }
    function closeAddModal() {
        addModal.classList.add('hidden');
        document.getElementById('add-modal-input-single').value = '';
        document.getElementById('add-modal-input-bulk').value = '';
    }
    function switchAddMode(mode) {
        currentAddMode = mode;
        document.getElementById('single-tab').classList.toggle('active', mode === 'single');
        document.getElementById('bulk-tab').classList.toggle('active', mode === 'bulk');
        document.getElementById('single-add-panel').style.display = mode === 'single' ? 'block' : 'none';
        document.getElementById('bulk-add-panel').style.display = mode === 'bulk' ? 'block' : 'none';
    }
    function handleBulkAddSave() {
        if (currentAddMode === 'single') {
            const name = document.getElementById('add-modal-input-single').value.trim();
            if (name) {
                if (currentAddType === 'product') {
                    products.push({ id: generateUUID(), name: name, parentId: null, isCollapsed: false });
                    renderProducts();
                } else {
                    features.push({ id: generateUUID(), name: name });
                    renderFeatures();
                }
            }
        } else { // Bulk mode
            const names = document.getElementById('add-modal-input-bulk').value
                .split('\n')
                .map(name => name.trim())
                .filter(name => name);
            
            if (names.length > 0) {
                if (currentAddType === 'product') {
                    names.forEach(name => products.push({ id: generateUUID(), name: name, parentId: null, isCollapsed: false }));
                    renderProducts();
                } else {
                    names.forEach(name => features.push({ id: generateUUID(), name: name }));
                    renderFeatures();
                }
            }
        }
        closeAddModal();
    }


    // --- EVENT HANDLERS ---
    function handleSelectItem(type, id) {
        if (currentMode !== 'editor') return;
        if (selectedItem.id === id && selectedItem.type === type) {
            selectedItem = { id: null, type: null }; // Deselect
        } else {
            selectedItem = { id, type };
        }
        addChildBtn.disabled = selectedItem.type !== 'product';
        renderAll();
    }
    
    function handleHoverItem(type, id) {
        if (currentMode !== 'viewer') return;
        hoveredItem = { type, id };
        renderAll();
    }

    function handleAddProduct() {
        openAddModal('product');
    }
    function handleAddChildProduct() {
        if (selectedItem.type !== 'product' || !selectedItem.id) return;
        openInputModal('Enter new child product name', '', (name) => {
            const parentId = selectedItem.id;
            products.push({ id: generateUUID(), name: name, parentId: parentId, isCollapsed: false });
            const parent = products.find(p => p.id === parentId);
            if (parent) parent.isCollapsed = false;
            renderProducts();
        });
    }
    function handleAddChildFromContext() {
        const parentId = rightClickedProductId;
        if (!parentId) return;
        openInputModal('Enter new child product name', '', (name) => {
            products.push({ id: generateUUID(), name: name, parentId: parentId, isCollapsed: false });
            const parent = products.find(p => p.id === parentId);
            if (parent) parent.isCollapsed = false;
            renderProducts();
        });
        rightClickedProductId = null;
    }
    function handleAddFeature() {
        openAddModal('feature');
    }
    function handleEditProduct(id) {
        const product = products.find(p => p.id === id);
        openInputModal('Edit product name', product.name, (newName) => {
            product.name = newName;
            renderProducts();
        });
    }
    function handleDeleteProduct(id) {
        openConfirmModal('This will delete the product and ALL its children. Continue?', () => {
            let toDelete = [id];
            let childrenToDelete = products.filter(p => p.parentId === id);
            while(childrenToDelete.length > 0) {
                const childId = childrenToDelete[0].id;
                toDelete.push(childId);
                childrenToDelete.shift();
                childrenToDelete.push(...products.filter(p => p.parentId === childId));
            }
            products = products.filter(p => !toDelete.includes(p.id));
            links = links.filter(l => !toDelete.includes(l.productId));
            if (toDelete.includes(selectedItem.id)) {
                selectedItem = { id: null, type: null };
                addChildBtn.disabled = true;
            }
            renderAll();
        });
    }
    function handleEditFeature(id) {
        const feature = features.find(f => f.id === id);
        openInputModal('Edit feature name', feature.name, (newName) => {
            feature.name = newName;
            renderFeatures();
        });
    }
    function handleDeleteFeature(id) {
        openConfirmModal('This will delete the feature and all its links. Continue?', () => {
            features = features.filter(f => f.id !== id);
            links = links.filter(l => l.featureId !== id);
            if (selectedItem.id === id) selectedItem = { id: null, type: null };
            renderAll();
        });
    }
    function handleToggleLink(featureId) {
        if (selectedItem.type !== 'product') return;
        const productId = selectedItem.id;
        const linkIndex = links.findIndex(l => l.productId === productId && l.featureId === featureId);
        if (linkIndex > -1) {
            links.splice(linkIndex, 1);
        } else {
            links.push({ productId, featureId });
        }
        renderAll();
    }
    
    function toggleCollapse(productId) {
        const product = products.find(p => p.id === productId);
        if (product) {
            product.isCollapsed = !product.isCollapsed;
        }
        renderProducts();
    }
    
    // --- DRAG & DROP HANDLERS ---
    function handleDragStart(e, productId) {
        draggedProductId = productId;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragOver(e) {
        e.preventDefault();
        const targetEl = e.target.closest('.list-item');
        if (!targetEl) return;
        const rect = targetEl.getBoundingClientRect();
        const middleY = rect.top + rect.height / 2;
        
        document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        const indicator = document.createElement('div');
        indicator.className = 'drop-indicator';

        if (e.clientY < middleY) {
            targetEl.parentNode.insertBefore(indicator, targetEl);
        } else {
            targetEl.parentNode.insertBefore(indicator, targetEl.nextSibling);
        }
    }

    function handleDragLeave(e) {
        document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
    }

    function handleDrop(e, targetProductId) {
        e.preventDefault();
        e.stopPropagation();
        
        const draggedProduct = products.find(p => p.id === draggedProductId);
        const targetProduct = products.find(p => p.id === targetProductId);
        if (!draggedProduct || !targetProduct || draggedProductId === targetProductId) return;
        if (isDescendant(draggedProductId, targetProductId)) {
            alert('Cannot move a product into one of its descendants.');
            return;
        }

        const indicator = document.querySelector('.drop-indicator');
        const dropTarget = e.target.closest('.list-item');
        
        const draggedIndex = products.findIndex(p => p.id === draggedProductId);
        products.splice(draggedIndex, 1);

        const dropTargetRect = dropTarget.getBoundingClientRect();
        const dropY = e.clientY - dropTargetRect.top;

        if (dropY > dropTargetRect.height * 0.25 && dropY < dropTargetRect.height * 0.75) {
            draggedProduct.parentId = targetProductId;
            const parent = products.find(p => p.id === targetProductId);
            if (parent) parent.isCollapsed = false;
            let targetIndex = products.findIndex(p => p.id === targetProductId);
            products.splice(targetIndex + 1, 0, draggedProduct);
        } else {
            draggedProduct.parentId = targetProduct.parentId;
            let targetIndex = products.findIndex(p => p.id === targetProductId);
            if (e.clientY < dropTargetRect.top + dropTargetRect.height / 2) {
                 products.splice(targetIndex, 0, draggedProduct);
            } else {
                 products.splice(targetIndex + 1, 0, draggedProduct);
            }
        }
        
        renderAll();
    }

    function handleDragEnd(e) {
        document.querySelectorAll('.list-item.dragging').forEach(el => el.classList.remove('dragging'));
        document.querySelectorAll('.drop-indicator').forEach(el => el.remove());
        draggedProductId = null;
    }
    
    // --- MODE MANAGEMENT ---
    function setMode(newMode) {
        currentMode = newMode;
        selectedItem = { id: null, type: null };
        hoveredItem = { id: null, type: null };
        addChildBtn.disabled = true;

        document.getElementById('editor-mode-btn').classList.toggle('active', newMode === 'editor');
        document.getElementById('viewer-mode-btn').classList.toggle('active', newMode === 'viewer');
        document.getElementById('editor-controls').style.display = newMode === 'editor' ? 'flex' : 'none';
        document.getElementById('save-btn').style.display = newMode === 'editor' ? 'inline-block' : 'none';

        renderAll();
    }

    // --- EXPORT & FILE HANDLING ---
    function exportToPNG() {
        const exportArea = document.getElementById('export-area');
        html2canvas(exportArea, {
            backgroundColor: '#f8fafc',
            allowTaint: true,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'product-feature-map.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    function saveMapToJSON() {
        const dataToSave = {
            products: products,
            features: features,
            links: links
        };
        const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", "product_feature_map.json");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    function loadMapFromJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            openConfirmModal('Loading a new file will replace the current map. Continue?', () => {
                try {
                    const data = JSON.parse(e.target.result);
                    products = data.products || [];
                    features = data.features || [];
                    links = data.links || [];
                    setMode('editor');
                } catch (error) {
                    alert('Error parsing file. Please make sure it is a valid map file.');
                    console.error("Error parsing JSON:", error);
                }
            });
        };
        reader.readAsText(file);
    }

    // --- THEME SELECTION ---
    const themeSelect = document.getElementById('theme-select');
    const themes = ['light', 'dark', 'blue', 'green'];

    function applyTheme(theme) {
        const htmlEl = document.documentElement;
        themes.forEach(t => htmlEl.classList.remove('theme-' + t));
        htmlEl.classList.remove('dark');
        if (theme === 'dark') {
            htmlEl.classList.add('dark');
        }
        htmlEl.classList.add('theme-' + theme);
    }

    function safeSetItem(key, value) {
        try { localStorage.setItem(key, value); } catch (e) { console.warn('Local storage unavailable', e); }
    }

    function safeGetItem(key) {
        try { return localStorage.getItem(key); } catch (e) { console.warn('Local storage unavailable', e); return null; }
    }

    function changeTheme(theme) {
        safeSetItem('theme', theme);
        applyTheme(theme);
    }

    function initTheme() {
        const stored = safeGetItem('theme');
        const preferred = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        const theme = stored || preferred;
        applyTheme(theme);
        themeSelect.value = theme;
    }

    themeSelect.addEventListener('change', (e) => changeTheme(e.target.value));

    // --- INITIALIZATION & RESIZE ---
    window.addEventListener('resize', drawConnectors);
    window.addEventListener('click', () => {
        productContextMenu.style.display = 'none';
    });
    let scrollFrame = null;
    function scheduleConnectorDraw() {
        if (scrollFrame) return;
        scrollFrame = requestAnimationFrame(() => {
            drawConnectors();
            scrollFrame = null;
        });
    }
    productsColumnEl.addEventListener('scroll', scheduleConnectorDraw);
    featuresColumnEl.addEventListener('scroll', scheduleConnectorDraw);
    document.addEventListener('DOMContentLoaded', () => {
        initTheme();
        setMode('editor');
    });
    </script>
</body>
</html>
