<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product-Feature Relationship Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body, html {
            overflow: hidden;
            height: 100%;
            font-family: 'Inter', sans-serif;
        }
        /* Style for the main container */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 80px); /* Full height minus top bar */
        }
        /* Style for selected items in lists */
        .list-item.selected {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
        /* SVG canvas for drawing connector lines */
        #svg-connector-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allows clicks to pass through */
            z-index: 0;
        }
        .list-item-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .list-item:hover .list-item-actions {
            opacity: 1;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-50">

    <div class="w-full h-full flex flex-col">
        <!-- Top Control Bar -->
        <div class="w-full bg-white shadow-md p-4 flex items-center justify-center gap-6 border-b border-slate-200 z-10">
            <button onclick="handleAddProduct()" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700 transition-colors shadow">Add Product</button>
            <button id="add-feature-btn" onclick="handleAddFeature()" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700 transition-colors shadow disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>Add Feature</button>
            
            <div class="h-8 border-l border-slate-300"></div>

            <button onclick="saveMapToCSV()" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-green-700 transition-colors shadow">Save (CSV)</button>
            <label for="csv-file-input" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-gray-700 transition-colors shadow cursor-pointer">Load (CSV)</label>
            <input type="file" id="csv-file-input" accept=".csv" onchange="loadMapFromCSV(event)">
        </div>

        <!-- Main Content Area -->
        <main class="flex-grow p-8 relative">
            <div class="main-container">
                <!-- Products Column -->
                <div id="products-column" class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Products</h2>
                    <div id="products-list" class="space-y-2">
                        <!-- Product items will be injected here -->
                    </div>
                </div>

                <!-- Features Column -->
                <div id="features-column" class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Features</h2>
                    <div id="features-list" class="space-y-2">
                         <!-- Feature items will be injected here -->
                    </div>
                </div>
            </div>
            
            <!-- SVG Canvas for connectors -->
            <svg id="svg-connector-canvas"></svg>
        </main>
    </div>

    <script>
    // --- DATA MANAGEMENT ---
    let products = [];
    let selectedProductId = null;

    // --- DOM ELEMENTS ---
    const productsListEl = document.getElementById('products-list');
    const featuresListEl = document.getElementById('features-list');
    const addFeatureBtn = document.getElementById('add-feature-btn');
    const svgCanvas = document.getElementById('svg-connector-canvas');

    // --- RENDER FUNCTIONS ---

    /**
     * Renders the entire list of products.
     */
    function renderProducts() {
        productsListEl.innerHTML = ''; // Clear the list
        products.forEach(product => {
            const isSelected = product.id === selectedProductId;
            const item = document.createElement('div');
            item.className = `list-item p-3 border rounded-md cursor-pointer flex justify-between items-center transition-colors ${isSelected ? 'selected' : 'border-slate-300 hover:bg-slate-100'}`;
            item.dataset.id = product.id;
            item.onclick = () => handleSelectProduct(product.id);
            
            item.innerHTML = `
                <span class="product-name">${product.name}</span>
                <div class="list-item-actions space-x-2">
                    <button onclick="event.stopPropagation(); handleEditProduct('${product.id}')" class="text-slate-500 hover:text-blue-600">&#9998;</button> <!-- Edit icon -->
                    <button onclick="event.stopPropagation(); handleDeleteProduct('${product.id}')" class="text-slate-500 hover:text-red-600">&#10006;</button> <!-- Delete icon -->
                </div>
            `;
            productsListEl.appendChild(item);
        });
        drawConnectors();
    }

    /**
     * Renders the features for the currently selected product.
     */
    function renderFeatures() {
        featuresListEl.innerHTML = ''; // Clear the list
        if (!selectedProductId) {
            featuresListEl.innerHTML = '<p class="text-slate-400 text-center">Select a product to see its features.</p>';
            return;
        }

        const product = products.find(p => p.id === selectedProductId);
        if (!product || !product.features || product.features.length === 0) {
            featuresListEl.innerHTML = '<p class="text-slate-400 text-center">No features linked to this product.</p>';
            return;
        }

        product.features.forEach(feature => {
            const item = document.createElement('div');
            item.className = 'list-item p-3 border border-slate-300 rounded-md flex justify-between items-center';
            item.dataset.id = feature.id;
            item.innerHTML = `
                <span>${feature.name}</span>
                <div class="list-item-actions space-x-2">
                    <button onclick="event.stopPropagation(); handleEditFeature('${feature.id}')" class="text-slate-500 hover:text-blue-600">&#9998;</button>
                    <button onclick="event.stopPropagation(); handleDeleteFeature('${feature.id}')" class="text-slate-500 hover:text-red-600">&#10006;</button>
                </div>
            `;
            featuresListEl.appendChild(item);
        });
        drawConnectors();
    }
    
    /**
     * Draws SVG lines connecting the selected product to its features.
     */
    function drawConnectors() {
        svgCanvas.innerHTML = '';
        if (!selectedProductId) return;

        const productEl = document.querySelector(`.list-item[data-id="${selectedProductId}"]`);
        if (!productEl) return;

        const productRect = productEl.getBoundingClientRect();
        const startX = productRect.right;
        const startY = productRect.top + productRect.height / 2;

        const featureItems = document.querySelectorAll('#features-list .list-item');
        featureItems.forEach(featureEl => {
            const featureRect = featureEl.getBoundingClientRect();
            const endX = featureRect.left;
            const endY = featureRect.top + featureRect.height / 2;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', startX);
            line.setAttribute('y1', startY);
            line.setAttribute('x2', endX);
            line.setAttribute('y2', endY);
            line.setAttribute('stroke', '#94a3b8'); // slate-400
            line.setAttribute('stroke-width', '2');
            svgCanvas.appendChild(line);
        });
    }

    // --- EVENT HANDLERS ---

    function handleSelectProduct(productId) {
        selectedProductId = productId;
        addFeatureBtn.disabled = false;
        renderProducts();
        renderFeatures();
    }

    function handleAddProduct() {
        const name = prompt("Enter the new product name:");
        if (name) {
            products.push({
                id: `prod_${Date.now()}`,
                name: name,
                features: []
            });
            renderProducts();
        }
    }

    function handleAddFeature() {
        if (!selectedProductId) return;
        const name = prompt("Enter the new feature name:");
        if (name) {
            const product = products.find(p => p.id === selectedProductId);
            product.features.push({
                id: `feat_${Date.now()}`,
                name: name
            });
            renderFeatures();
        }
    }
    
    function handleEditProduct(productId) {
        const product = products.find(p => p.id === productId);
        const newName = prompt("Edit product name:", product.name);
        if (newName) {
            product.name = newName;
            renderProducts();
        }
    }

    function handleDeleteProduct(productId) {
        if (confirm("Are you sure you want to delete this product and all its linked features?")) {
            products = products.filter(p => p.id !== productId);
            if (selectedProductId === productId) {
                selectedProductId = null;
                addFeatureBtn.disabled = true;
                renderFeatures();
            }
            renderProducts();
        }
    }
    
    function handleEditFeature(featureId) {
        const product = products.find(p => p.id === selectedProductId);
        const feature = product.features.find(f => f.id === featureId);
        const newName = prompt("Edit feature name:", feature.name);
        if (newName) {
            feature.name = newName;
            renderFeatures();
        }
    }

    function handleDeleteFeature(featureId) {
        if (confirm("Are you sure you want to delete this feature?")) {
            const product = products.find(p => p.id === selectedProductId);
            product.features = product.features.filter(f => f.id !== featureId);
            renderFeatures();
        }
    }

    // --- CSV & FILE HANDLING ---

    function saveMapToCSV() {
        let csvContent = "product_id,product_name,feature_id,feature_name\n";
        products.forEach(product => {
            if (product.features.length > 0) {
                product.features.forEach(feature => {
                    const row = [product.id, `"${product.name}"`, feature.id, `"${feature.name}"`].join(',');
                    csvContent += row + '\r\n';
                });
            } else {
                // Save product even if it has no features
                csvContent += [product.id, `"${product.name}"`, '', ''].join(',') + '\r\n';
            }
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "product_feature_map.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function loadMapFromCSV(event) {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (!confirm("Loading a new file will replace the current map. Continue?")) return;
                
                const newProducts = new Map();
                results.data.forEach(row => {
                    if (!row.product_id || !row.product_name) return;

                    // Add product if it doesn't exist
                    if (!newProducts.has(row.product_id)) {
                        newProducts.set(row.product_id, {
                            id: row.product_id,
                            name: row.product_name.replace(/"/g, ''),
                            features: []
                        });
                    }
                    
                    // Add feature if it exists in the row
                    if (row.feature_id && row.feature_name) {
                        const product = newProducts.get(row.product_id);
                        product.features.push({
                            id: row.feature_id,
                            name: row.feature_name.replace(/"/g, '')
                        });
                    }
                });

                products = Array.from(newProducts.values());
                selectedProductId = null;
                addFeatureBtn.disabled = true;
                renderProducts();
                renderFeatures();
            }
        });
    }

    // --- INITIALIZATION & RESIZE ---
    window.addEventListener('resize', drawConnectors);
    // Initial render
    renderProducts();
    renderFeatures();
    </script>
</body>
</html>

