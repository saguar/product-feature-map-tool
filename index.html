<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product-Feature Relationship Map</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <!-- Added html2canvas library for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body, html {
            overflow: hidden;
            height: 100%;
            font-family: 'Inter', sans-serif;
        }
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 80px);
        }
        .list-item.selected {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
            font-weight: 600;
        }
        .list-item.linked {
            background-color: #e0e7ff; /* indigo-100 */
            border-style: dashed;
        }
        .list-item.hovered {
            background-color: #fef9c3; /* yellow-100 */
        }
        #svg-connector-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .list-item-actions {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .list-item:hover .list-item-actions {
            opacity: 1;
        }
        .mode-button.active {
            background-color: #0284c7; /* sky-600 */
            color: white;
            font-weight: 600;
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-slate-50">

    <div class="w-full h-full flex flex-col">
        <!-- Top Control Bar -->
        <div class="w-full bg-white shadow-md p-4 flex items-center justify-center gap-6 border-b border-slate-200 z-10">
            <div id="mode-switcher" class="bg-slate-200 rounded-lg p-1">
                <button id="editor-mode-btn" onclick="setMode('editor')" class="mode-button px-3 py-1 rounded-md text-sm text-slate-700 transition-colors">Editor</button>
                <button id="viewer-mode-btn" onclick="setMode('viewer')" class="mode-button px-3 py-1 rounded-md text-sm text-slate-700 transition-colors">Viewer</button>
            </div>
            
            <div class="h-8 border-l border-slate-300"></div>

            <div id="editor-controls" class="flex items-center gap-6">
                <button onclick="handleAddProduct()" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700 transition-colors shadow">Add Product</button>
                <button onclick="handleAddFeature()" class="bg-sky-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-sky-700 transition-colors shadow">Add Feature</button>
            </div>
            
            <div class="h-8 border-l border-slate-300"></div>

            <div>
                <button id="save-btn" onclick="saveMapToCSV()" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-green-700 transition-colors shadow">Save (CSV)</button>
                <label for="csv-file-input" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-gray-700 transition-colors shadow cursor-pointer">Load (CSV)</label>
                <input type="file" id="csv-file-input" accept=".csv" onchange="loadMapFromCSV(event)">
                <!-- Added Export to PNG button -->
                <button onclick="exportToPNG()" class="bg-purple-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-purple-700 transition-colors shadow">Export (PNG)</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <main id="export-area" class="flex-grow p-8 relative bg-slate-50">
            <div class="main-container">
                <!-- Products Column -->
                <div id="products-column" class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Products</h2>
                    <div id="products-list" class="space-y-2 list-none"></div>
                </div>
                <!-- Features Column -->
                <div id="features-column" class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 text-center">Features</h2>
                    <div id="features-list" class="space-y-2 list-none"></div>
                </div>
            </div>
            <svg id="svg-connector-canvas"></svg>
        </main>
    </div>

    <!-- Modals -->
    <div id="input-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-bold mb-4"></h3>
            <input type="text" id="modal-input" class="w-full px-3 py-2 border border-slate-300 rounded-md">
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeInputModal()" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cancel</button>
                <button onclick="handleModalSave()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-2">Are you sure?</h3>
            <p id="confirm-modal-text" class="text-slate-600 mb-4"></p>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-slate-200 rounded-md hover:bg-slate-300">Cancel</button>
                <button onclick="handleModalConfirm()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
    // --- DATA MANAGEMENT ---
    let products = [];
    let features = [];
    let links = [];
    let selectedItem = { id: null, type: null };
    let hoveredItem = { id: null, type: null };
    let currentMode = 'editor';

    // --- DOM ELEMENTS ---
    const productsListEl = document.getElementById('products-list');
    const featuresListEl = document.getElementById('features-list');
    const svgCanvas = document.getElementById('svg-connector-canvas');
    const inputModal = document.getElementById('input-modal'), modalTitle = document.getElementById('modal-title'), modalInput = document.getElementById('modal-input');
    const confirmModal = document.getElementById('confirm-modal'), confirmModalText = document.getElementById('confirm-modal-text');

    // --- MODAL STATE ---
    let onSaveCallback = null;
    let onConfirmCallback = null;

    // --- RENDER FUNCTIONS ---
    function renderAll() {
        renderProducts();
        renderFeatures();
        setTimeout(drawConnectors, 0);
    }

    function renderProducts() {
        productsListEl.innerHTML = '';
        products.forEach(product => {
            let itemClass = 'list-item p-3 border rounded-md flex justify-between items-center transition-colors border-slate-300';
            if (currentMode === 'editor') {
                itemClass += ' cursor-pointer hover:bg-slate-100';
                if (selectedItem.type === 'product' && product.id === selectedItem.id) itemClass += ' selected';
            }
            if (selectedItem.type === 'feature' && links.some(l => l.productId === product.id && l.featureId === selectedItem.id)) {
                itemClass += ' linked';
            }
            if (currentMode === 'viewer' && hoveredItem.type === 'feature' && links.some(l => l.productId === product.id && l.featureId === hoveredItem.id)) {
                itemClass += ' linked';
            }
            if (currentMode === 'viewer' && hoveredItem.type === 'product' && product.id === hoveredItem.id) {
                itemClass += ' hovered';
            }

            const item = document.createElement('div');
            item.className = itemClass;
            item.dataset.id = product.id;
            item.onclick = () => handleSelectItem('product', product.id);
            item.onmouseover = () => handleHoverItem('product', product.id);
            item.onmouseout = () => handleHoverItem(null, null);

            item.innerHTML = `
                <span>${product.name}</span>
                ${currentMode === 'editor' ? `
                <div class="list-item-actions space-x-2">
                    <button onclick="event.stopPropagation(); handleEditProduct('${product.id}')" class="text-slate-500 hover:text-blue-600" title="Edit">&#9998;</button>
                    <button onclick="event.stopPropagation(); handleDeleteProduct('${product.id}')" class="text-slate-500 hover:text-red-600" title="Delete">&#10006;</button>
                </div>` : ''}`;
            productsListEl.appendChild(item);
        });
    }

    function renderFeatures() {
        featuresListEl.innerHTML = '';
        features.forEach(feature => {
            let itemClass = 'list-item p-3 border rounded-md flex justify-between items-center transition-colors border-slate-300';
            let linkButton = '';

            if (currentMode === 'editor') {
                itemClass += ' cursor-pointer hover:bg-slate-100';
                if (selectedItem.type === 'feature' && feature.id === selectedItem.id) itemClass += ' selected';
                if (selectedItem.type === 'product') {
                    const isLinked = links.some(l => l.productId === selectedItem.id && l.featureId === feature.id);
                    if (isLinked) itemClass += ' linked';
                    const btnText = isLinked ? 'Unlink' : 'Link';
                    const btnColor = isLinked ? 'bg-amber-500 hover:bg-amber-600' : 'bg-teal-500 hover:bg-teal-600';
                    linkButton = `<button onclick="event.stopPropagation(); handleToggleLink('${feature.id}')" class="text-xs text-white px-2 py-1 rounded ${btnColor}">${btnText}</button>`;
                }
            }
            if (currentMode === 'viewer' && hoveredItem.type === 'product' && links.some(l => l.featureId === feature.id && l.productId === hoveredItem.id)) {
                itemClass += ' linked';
            }
            if (currentMode === 'viewer' && hoveredItem.type === 'feature' && feature.id === hoveredItem.id) {
                itemClass += ' hovered';
            }

            const item = document.createElement('div');
            item.className = itemClass;
            item.dataset.id = feature.id;
            item.onclick = () => handleSelectItem('feature', feature.id);
            item.onmouseover = () => handleHoverItem('feature', feature.id);
            item.onmouseout = () => handleHoverItem(null, null);

            item.innerHTML = `
                <span>${feature.name}</span>
                <div class="flex items-center gap-2">
                    ${linkButton}
                    ${currentMode === 'editor' ? `
                    <div class="list-item-actions space-x-2">
                        <button onclick="event.stopPropagation(); handleEditFeature('${feature.id}')" class="text-slate-500 hover:text-blue-600" title="Edit">&#9998;</button>
                        <button onclick="event.stopPropagation(); handleDeleteFeature('${feature.id}')" class="text-slate-500 hover:text-red-600" title="Delete">&#10006;</button>
                    </div>` : ''}
                </div>`;
            featuresListEl.appendChild(item);
        });
    }
    
    function drawConnectors() {
        svgCanvas.innerHTML = '';
        const itemToDraw = currentMode === 'editor' ? selectedItem : hoveredItem;
        if (!itemToDraw.id) return;

        if (itemToDraw.type === 'product') {
            const productEl = document.querySelector(`#products-list .list-item[data-id="${itemToDraw.id}"]`);
            if (!productEl) return;
            const linkedFeatureIds = links.filter(l => l.productId === itemToDraw.id).map(l => l.featureId);
            linkedFeatureIds.forEach(featureId => {
                const featureEl = document.querySelector(`#features-list .list-item[data-id="${featureId}"]`);
                if (featureEl) drawBezierCurve(productEl, featureEl);
            });
        } else if (itemToDraw.type === 'feature') {
            const featureEl = document.querySelector(`#features-list .list-item[data-id="${itemToDraw.id}"]`);
            if (!featureEl) return;
            const linkedProductIds = links.filter(l => l.featureId === itemToDraw.id).map(l => l.productId);
            linkedProductIds.forEach(productId => {
                const productEl = document.querySelector(`#products-list .list-item[data-id="${productId}"]`);
                if (productEl) drawBezierCurve(productEl, featureEl);
            });
        }
    }

    function drawBezierCurve(startEl, endEl) {
        const svgParentRect = svgCanvas.parentElement.getBoundingClientRect();
        const startRect = startEl.getBoundingClientRect();
        const endRect = endEl.getBoundingClientRect();
        const x1 = startRect.right - svgParentRect.left;
        const y1 = (startRect.top + startRect.height / 2) - svgParentRect.top;
        const x2 = endRect.left - svgParentRect.left;
        const y2 = (endRect.top + endRect.height / 2) - svgParentRect.top;
        const cx = (x1 + x2) / 2;
        const pathData = `M ${x1},${y1} C ${cx},${y1} ${cx},${y2} ${x2},${y2}`;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('stroke', '#94a3b8');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        svgCanvas.appendChild(path);
    }

    // --- MODAL HANDLERS ---
    function openInputModal(title, value, callback) {
        modalTitle.textContent = title;
        modalInput.value = value;
        onSaveCallback = callback;
        inputModal.classList.remove('hidden');
        modalInput.focus();
    }
    function closeInputModal() { inputModal.classList.add('hidden'); onSaveCallback = null; }
    function handleModalSave() {
        if (onSaveCallback && modalInput.value.trim()) onSaveCallback(modalInput.value.trim());
        closeInputModal();
    }
    function openConfirmModal(text, callback) {
        confirmModalText.textContent = text;
        onConfirmCallback = callback;
        confirmModal.classList.remove('hidden');
    }
    function closeConfirmModal() { confirmModal.classList.add('hidden'); onConfirmCallback = null; }
    function handleModalConfirm() {
        if (onConfirmCallback) onConfirmCallback();
        closeConfirmModal();
    }
    modalInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleModalSave();
        if (e.key === 'Escape') closeInputModal();
    });

    // --- EVENT HANDLERS ---
    function handleSelectItem(type, id) {
        if (currentMode !== 'editor') return;
        if (selectedItem.id === id && selectedItem.type === type) {
            selectedItem = { id: null, type: null }; // Deselect
        } else {
            selectedItem = { id, type };
        }
        renderAll();
    }
    
    function handleHoverItem(type, id) {
        if (currentMode !== 'viewer') return;
        hoveredItem = { type, id };
        renderAll();
    }

    function handleAddProduct() {
        openInputModal('Enter new product name', '', (name) => {
            products.push({ id: crypto.randomUUID(), name: name });
            renderProducts();
        });
    }
    function handleAddFeature() {
        openInputModal('Enter new feature name', '', (name) => {
            features.push({ id: crypto.randomUUID(), name: name });
            renderFeatures();
        });
    }
    function handleEditProduct(id) {
        const product = products.find(p => p.id === id);
        openInputModal('Edit product name', product.name, (newName) => {
            product.name = newName;
            renderProducts();
        });
    }
    function handleDeleteProduct(id) {
        openConfirmModal('This will delete the product and all its links. Continue?', () => {
            products = products.filter(p => p.id !== id);
            links = links.filter(l => l.productId !== id);
            if (selectedItem.id === id) selectedItem = { id: null, type: null };
            renderAll();
        });
    }
    function handleEditFeature(id) {
        const feature = features.find(f => f.id === id);
        openInputModal('Edit feature name', feature.name, (newName) => {
            feature.name = newName;
            renderFeatures();
        });
    }
    function handleDeleteFeature(id) {
        openConfirmModal('This will delete the feature and all its links. Continue?', () => {
            features = features.filter(f => f.id !== id);
            links = links.filter(l => l.featureId !== id);
            if (selectedItem.id === id) selectedItem = { id: null, type: null };
            renderAll();
        });
    }
    function handleToggleLink(featureId) {
        if (selectedItem.type !== 'product') return;
        const productId = selectedItem.id;
        const linkIndex = links.findIndex(l => l.productId === productId && l.featureId === featureId);
        if (linkIndex > -1) {
            links.splice(linkIndex, 1); // Unlink
        } else {
            links.push({ productId, featureId }); // Link
        }
        renderAll();
    }
    
    // --- MODE MANAGEMENT ---
    function setMode(newMode) {
        currentMode = newMode;
        selectedItem = { id: null, type: null };
        hoveredItem = { id: null, type: null };

        document.getElementById('editor-mode-btn').classList.toggle('active', newMode === 'editor');
        document.getElementById('viewer-mode-btn').classList.toggle('active', newMode === 'viewer');
        document.getElementById('editor-controls').style.display = newMode === 'editor' ? 'flex' : 'none';
        document.getElementById('save-btn').style.display = newMode === 'editor' ? 'inline-block' : 'none';

        renderAll();
    }

    // --- EXPORT & FILE HANDLING ---
    function exportToPNG() {
        const exportArea = document.getElementById('export-area');
        html2canvas(exportArea, {
            // Ensure the background is captured correctly
            backgroundColor: '#f8fafc',
            // Improve rendering of SVG elements
            allowTaint: true,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'product-feature-map.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    function saveMapToCSV() {
        let dataToSave = [];
        const savedFeatures = new Set();
        products.forEach(p => {
            const linkedFeatures = links.filter(l => l.productId === p.id);
            if (linkedFeatures.length > 0) {
                linkedFeatures.forEach(l => {
                    const f = features.find(feat => feat.id === l.featureId);
                    if (f) {
                        dataToSave.push({ product_id: p.id, product_name: p.name, feature_id: f.id, feature_name: f.name });
                        savedFeatures.add(f.id);
                    }
                });
            } else {
                dataToSave.push({ product_id: p.id, product_name: p.name, feature_id: '', feature_name: '' });
            }
        });
        features.forEach(f => {
            if (!savedFeatures.has(f.id)) {
                dataToSave.push({ product_id: '', product_name: '', feature_id: f.id, feature_name: f.name });
            }
        });
        const csv = Papa.unparse(dataToSave);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.setAttribute("href", URL.createObjectURL(blob));
        link.setAttribute("download", "product_feature_map.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    function loadMapFromCSV(event) {
        const file = event.target.files[0];
        if (!file) return;
        openConfirmModal('Loading a new file will replace the current map. Continue?', () => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const tempProducts = new Map();
                    const tempFeatures = new Map();
                    const tempLinks = [];
                    results.data.forEach(row => {
                        if (row.product_id && row.product_name && !tempProducts.has(row.product_id)) {
                            tempProducts.set(row.product_id, { id: row.product_id, name: row.product_name });
                        }
                        if (row.feature_id && row.feature_name && !tempFeatures.has(row.feature_id)) {
                            tempFeatures.set(row.feature_id, { id: row.feature_id, name: row.feature_name });
                        }
                        if (row.product_id && row.feature_id) {
                            tempLinks.push({ productId: row.product_id, featureId: row.feature_id });
                        }
                    });
                    products = Array.from(tempProducts.values());
                    features = Array.from(tempFeatures.values());
                    links = tempLinks;
                    setMode('editor'); // Reset to editor mode after loading
                }
            });
        });
    }

    // --- INITIALIZATION & RESIZE ---
    window.addEventListener('resize', drawConnectors);
    document.addEventListener('DOMContentLoaded', () => {
        setMode('editor');
    });
    </script>
</body>
</html>
